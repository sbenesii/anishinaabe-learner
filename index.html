<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Anishinaabemowin">
    <meta name="theme-color" content="#87CEEB">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect width='180' height='180' fill='%2387CEEB'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='80' fill='white'>ᐊ</text></svg>">
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22Anishinaabemowin%20Learner%22,%22short_name%22:%22Anishinaabemowin%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f8f5f0%22,%22theme_color%22:%22%2387CEEB%22,%22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect width='512' height='512' fill='%2387CEEB'/><text x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-size='280' fill='white'>ᐊ</text></svg>%22,%22sizes%22:%22512x512%22,%22type%22:%22image/svg+xml%22}]}">
    <title>Anishinaabemowin Learner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: #f8f5f0;
            min-height: 100vh;
        }
        
        .header {
            background-color: #87CEEB;
            color: white;
            padding: 20px;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        h1 {
            margin: 0 0 15px 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .search-bar {
            display: flex;
            gap: 8px;
        }
        
        #searchInput {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid white;
            font-size: 16px;
            outline: none;
        }
        
        button {
            padding: 12px 20px;
            background-color: #5DADE2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
        }
        
        button:hover {
            background-color: #3498DB;
        }
        
        button:disabled {
            background-color: #999;
            cursor: wait;
        }
        
        .tab-header {
            background-color: white;
            border-bottom: 3px solid #87CEEB;
            padding: 16px 20px;
            font-weight: 600;
            color: #3498DB;
        }
        
        .tab {
            flex: 1;
            padding: 16px;
            border: none;
            background-color: white;
            cursor: pointer;
            font-weight: 400;
            color: #666;
            border-bottom: 3px solid transparent;
            font-size: 16px;
        }
        
        .tab.active {
            background-color: #f8f5f0;
            border-bottom-color: #87CEEB;
            font-weight: 600;
            color: #3498DB;
        }
        
        .hidden {
            display: none;
        }
        
        .content {
            padding: 20px;
        }
        
        .word-card {
            background-color: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 12px;
            position: relative;
        }
        
        .word-ojibwe {
            font-size: 20px;
            font-weight: 600;
            color: #3498DB;
            margin-bottom: 4px;
        }
        
        .word-english {
            font-size: 14px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .remove-btn {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            color: #999;
            padding: 4px 8px;
            font-size: 18px;
        }
        
        .status {
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 8px;
            text-align: center;
        }
        
        .status.info {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .status.error {
            background-color: #ffebee;
            color: #c62828;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Anishinaabemowin</h1>
        <div class="search-bar">
            <input 
                type="text" 
                id="searchInput" 
                placeholder="Search English word (e.g., 'run', 'water')..."
                autocomplete="off"
            >
            <button id="searchBtn">Search & Add</button>
        </div>
    </div>
    
    <div style="display: flex; background-color: white; border-bottom: 1px solid #e0d5c7;">
        <button id="wordsTab" class="tab active" onclick="switchTab('words')">
            My Words (<span id="wordCount">0</span>)
        </button>
        <button id="sentencesTab" class="tab" onclick="switchTab('sentences')">
            Sentences
        </button>
    </div>
    
    <div class="content">
        <div id="statusArea"></div>
        
        <!-- Words View -->
        <div id="wordsView">
            <div id="collectionView">
                <div class="empty-state">
                    <p>Your collection is empty.</p>
                    <p style="font-size: 14px;">Search for an English word to find its Anishinaabemowin translation.</p>
                </div>
            </div>
        </div>
        
        <!-- Sentences View -->
        <div id="sentencesView" class="hidden">
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #3498DB;">
                    Enter a sentence to translate:
                </label>
                <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                    <select id="translateDirection" style="padding: 12px; border-radius: 8px; border: 2px solid #e0d5c7; font-size: 16px;">
                        <option value="en-to-oj">English → Anishinaabemowin</option>
                        <option value="oj-to-en">Anishinaabemowin → English</option>
                    </select>
                </div>
                <textarea 
                    id="sentenceInput" 
                    placeholder="Type your sentence here..."
                    style="width: 100%; padding: 12px; border-radius: 8px; border: 2px solid #e0d5c7; font-size: 16px; min-height: 100px; resize: vertical; font-family: inherit;"
                ></textarea>
                <button id="translateBtn" style="margin-top: 12px; width: 100%;">Translate</button>
            </div>
            
            <div id="translationResult" style="display: none;">
                <div style="background-color: white; padding: 20px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                    <h3 style="margin: 0 0 12px 0; color: #3498DB;">Translation:</h3>
                    <div id="translationText" style="font-size: 18px; line-height: 1.6; margin-bottom: 16px;"></div>
                    <div id="grammarNotes" style="padding-top: 16px; border-top: 1px solid #e0d5c7; color: #666; font-size: 14px;"></div>
                </div>
            </div>
            
            <div id="sentenceHistory" style="margin-top: 24px;">
                <h3 style="margin-bottom: 12px; color: #3498DB;">Recent Translations</h3>
                <div id="historyList"></div>
            </div>
        </div>
    </div>

    <script>
        let myWords = [];
        let translationHistory = [];
        
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const collectionView = document.getElementById('collectionView');
        const wordCount = document.getElementById('wordCount');
        const statusArea = document.getElementById('statusArea');
        const wordsView = document.getElementById('wordsView');
        const sentencesView = document.getElementById('sentencesView');
        const wordsTab = document.getElementById('wordsTab');
        const sentencesTab = document.getElementById('sentencesTab');
        const sentenceInput = document.getElementById('sentenceInput');
        const translateBtn = document.getElementById('translateBtn');
        const translateDirection = document.getElementById('translateDirection');
        const translationResult = document.getElementById('translationResult');
        const translationText = document.getElementById('translationText');
        const grammarNotes = document.getElementById('grammarNotes');
        const historyList = document.getElementById('historyList');
        
        function switchTab(tab) {
            if (tab === 'words') {
                wordsView.classList.remove('hidden');
                sentencesView.classList.add('hidden');
                wordsTab.classList.add('active');
                sentencesTab.classList.remove('active');
            } else {
                wordsView.classList.add('hidden');
                sentencesView.classList.remove('hidden');
                wordsTab.classList.remove('active');
                sentencesTab.classList.add('active');
            }
        }
        
        function loadWords() {
            const saved = localStorage.getItem('anishinaabe-words');
            if (saved) {
                myWords = JSON.parse(saved);
                renderCollection();
            }
            
            const savedHistory = localStorage.getItem('anishinaabe-translations');
            if (savedHistory) {
                translationHistory = JSON.parse(savedHistory);
                renderHistory();
            }
        }
        
        function saveWords() {
            localStorage.setItem('anishinaabe-words', JSON.stringify(myWords));
            wordCount.textContent = myWords.length;
        }
        
        function saveHistory() {
            localStorage.setItem('anishinaabe-translations', JSON.stringify(translationHistory));
        }
        
        function showStatus(message, type = 'info') {
            statusArea.innerHTML = `<div class="status ${type}">${message}</div>`;
            if (type === 'info') {
                setTimeout(() => statusArea.innerHTML = '', 3000);
            }
        }
        
        async function translateSentence() {
            const sentence = sentenceInput.value.trim();
            if (!sentence) {
                showStatus('Please enter a sentence to translate', 'error');
                return;
            }
            
            const direction = translateDirection.value;
            const isEnToOj = direction === 'en-to-oj';
            
            translateBtn.disabled = true;
            translateBtn.textContent = 'Translating...';
            showStatus('Translating...');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 2000,
                        messages: [{
                            role: 'user',
                            content: `Translate this ${isEnToOj ? 'English' : 'Anishinaabemowin/Ojibwe'} sentence to ${isEnToOj ? 'Anishinaabemowin/Ojibwe' : 'English'}: "${sentence}"

Use these authoritative sources for accurate translation:
1. Ojibwe People's Dictionary (ojibwe.lib.umn.edu) - contemporary Minnesota Ojibwe
2. Freelang Ojibwe Dictionary (freelang.net/online/ojibwe.php) - comprehensive multi-dialect
3. Baraga's Dictionary of the Ojibway Language - historical Lake Superior region

Reference Anishinaabemowin grammar including:
- Verb-initial word order (VOS/VSO)
- Animate/inanimate noun classes
- Verb conjugations (VAI, VII, VTA, VTI)
- Obviation and direction marking
- Preverbs and word order

Return ONLY a JSON object in this exact format with no markdown or explanation:
{
  "translation": "the translated sentence",
  "grammar_notes": "brief notes about grammatical structures used, including which dictionary sources were consulted"
}

If you cannot translate it accurately, return:
{
  "translation": "",
  "grammar_notes": "explanation of why translation is difficult"
}`
                        }],
                        tools: [{
                            type: "web_search_20250305",
                            name: "web_search"
                        }]
                    })
                });
                
                const data = await response.json();
                console.log('Translation API Response:', JSON.stringify(data, null, 2));
                
                let resultText = '';
                if (data.content && Array.isArray(data.content)) {
                    for (const block of data.content) {
                        if (block.type === 'text') {
                            resultText += block.text;
                        }
                    }
                }
                
                console.log('Raw translation text:', resultText);
                console.log('Text length:', resultText.length);
                
                // Remove markdown code blocks
                resultText = resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                console.log('After removing markdown:', resultText);
                
                // Try to extract JSON from the response
                let jsonMatch = resultText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    resultText = jsonMatch[0];
                    console.log('Extracted JSON:', resultText);
                } else {
                    console.error('No JSON found in response');
                    console.error('Full response:', resultText);
                    throw new Error('No JSON object found in response');
                }
                
                let result;
                try {
                    result = JSON.parse(resultText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Failed to parse:', resultText);
                    throw parseError;
                }
                
                if (result.translation) {
                    translationText.textContent = result.translation;
                    grammarNotes.innerHTML = `<strong>Grammar Notes:</strong> ${result.grammar_notes}`;
                    translationResult.style.display = 'block';
                    
                    // Add to history
                    translationHistory.unshift({
                        id: Date.now().toString(),
                        original: sentence,
                        translation: result.translation,
                        direction: direction,
                        date: new Date().toISOString()
                    });
                    if (translationHistory.length > 10) translationHistory.pop();
                    saveHistory();
                    renderHistory();
                    
                    showStatus('Translation complete!');
                } else {
                    showStatus('Could not translate. ' + result.grammar_notes, 'error');
                }
                
            } catch (error) {
                console.error('Translation error details:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                showStatus('Error translating: ' + error.message, 'error');
            } finally {
                translateBtn.disabled = false;
                translateBtn.textContent = 'Translate';
            }
        }
        
        function renderHistory() {
            if (translationHistory.length === 0) {
                historyList.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">No translations yet.</p>';
                return;
            }
            
            historyList.innerHTML = translationHistory.map(item => `
                <div style="background-color: white; padding: 16px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 12px;">
                    <div style="font-size: 14px; color: #999; margin-bottom: 8px;">
                        ${item.direction === 'en-to-oj' ? 'English → Anishinaabemowin' : 'Anishinaabemowin → English'}
                    </div>
                    <div style="margin-bottom: 8px;">
                        <strong style="color: #666;">Original:</strong> ${escapeHtml(item.original)}
                    </div>
                    <div style="color: #3498DB;">
                        <strong>Translation:</strong> ${escapeHtml(item.translation)}
                    </div>
                </div>
            `).join('');
        }
        
        async function searchAndAdd() {
            const query = searchInput.value.trim();
            if (!query) {
                showStatus('Please enter a word to search', 'error');
                return;
            }
            
            searchBtn.disabled = true;
            searchBtn.textContent = 'Searching...';
            showStatus('Looking up Ojibwe translation...');
            
            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 1000,
                        messages: [{
                            role: 'user',
                            content: `Look up the Ojibwe/Anishinaabemowin word for "${query}" using these sources:
1. Ojibwe People's Dictionary (ojibwe.lib.umn.edu)
2. Freelang Ojibwe Dictionary (freelang.net/online/ojibwe.php) 
3. Baraga's Dictionary of the Ojibway Language

Search all three sources and return the BEST or most common translation.

Return ONLY a JSON object in this exact format with no markdown or explanation:
{
  "ojibwe": "the ojibwe word",
  "english": "the english definition",
  "source": "which dictionary this came from (OPD, Freelang, or Baraga)",
  "notes": "any dialectal notes or variations from other dictionaries (optional)"
}

If you find multiple valid translations from different sources, choose the most contemporary/commonly used one.
If you can't find it in any source, return:
{"ojibwe": "", "english": "", "source": "", "notes": ""}`
                        }],
                        tools: [{
                            type: "web_search_20250305",
                            name: "web_search"
                        }]
                    })
                });
                
                const data = await response.json();
                console.log('Word Search API Response:', JSON.stringify(data, null, 2));
                
                let resultText = '';
                if (data.content && Array.isArray(data.content)) {
                    for (const block of data.content) {
                        if (block.type === 'text') {
                            resultText += block.text;
                        }
                    }
                }
                
                console.log('Raw word search text:', resultText);
                console.log('Text length:', resultText.length);
                
                // Remove markdown code blocks
                resultText = resultText.replace(/```json\s*/g, '').replace(/```\s*/g, '').trim();
                console.log('After removing markdown:', resultText);
                
                // Try to extract JSON from the response
                let jsonMatch = resultText.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    resultText = jsonMatch[0];
                    console.log('Extracted JSON:', resultText);
                } else {
                    console.error('No JSON found in response');
                    console.error('Full response:', resultText);
                    throw new Error('No JSON object found in response');
                }
                
                let result;
                try {
                    result = JSON.parse(resultText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    console.error('Failed to parse:', resultText);
                    throw parseError;
                }
                
                if (result.ojibwe && result.english) {
                    const newWord = {
                        id: Date.now().toString(),
                        ojibwe: result.ojibwe,
                        english: result.english,
                        source: result.source || '',
                        notes: result.notes || '',
                        addedDate: new Date().toISOString()
                    };
                    
                    myWords.push(newWord);
                    saveWords();
                    renderCollection();
                    const sourceInfo = result.source ? ` (${result.source})` : '';
                    showStatus(`Added: ${result.ojibwe} (${result.english})${sourceInfo}`);
                    searchInput.value = '';
                } else {
                    showStatus('Could not find translation. Try searching the dictionary manually.', 'error');
                }
                
            } catch (error) {
                console.error('Word search error details:', error);
                console.error('Error name:', error.name);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                showStatus('Error searching: ' + error.message, 'error');
            } finally {
                searchBtn.disabled = false;
                searchBtn.textContent = 'Search & Add';
            }
        }
        
        function renderCollection() {
            if (myWords.length === 0) {
                collectionView.innerHTML = `
                    <div class="empty-state">
                        <p>Your collection is empty.</p>
                        <p style="font-size: 14px;">Search for an English word to find its Anishinaabemowin translation.</p>
                    </div>
                `;
            } else {
                collectionView.innerHTML = myWords.map(word => `
                    <div class="word-card">
                        <div class="word-ojibwe">${escapeHtml(word.ojibwe)}</div>
                        <div class="word-english">${escapeHtml(word.english)}</div>
                        ${word.source ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">Source: ${escapeHtml(word.source)}</div>` : ''}
                        ${word.notes ? `<div style="font-size: 12px; color: #666; margin-top: 4px; font-style: italic;">${escapeHtml(word.notes)}</div>` : ''}
                        <button class="remove-btn" onclick="removeWord('${word.id}')">✕</button>
                    </div>
                `).join('');
            }
            wordCount.textContent = myWords.length;
        }
        
        function removeWord(wordId) {
            myWords = myWords.filter(w => w.id !== wordId);
            saveWords();
            renderCollection();
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        searchBtn.addEventListener('click', searchAndAdd);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchAndAdd();
        });
        
        translateBtn.addEventListener('click', translateSentence);
        sentenceInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) translateSentence();
        });
        
        loadWords();
        
        // Register service worker for PWA functionality (offline support)
        if ('serviceWorker' in navigator) {
            // Simple inline service worker for caching
            const swCode = `
                self.addEventListener('install', (e) => {
                    self.skipWaiting();
                });
                self.addEventListener('activate', (e) => {
                    self.clients.claim();
                });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl);
        }
        
        // Show install prompt for iOS
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
        });
    </script>
</body>
</html>
